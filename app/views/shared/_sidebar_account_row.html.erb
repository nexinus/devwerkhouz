<div class="sticky bottom-0 z-30 bg-white border-t border-neutral-100 py-2 px-3">
  <div data-controller="account-menu" class="relative">
    <!-- Interactive header (button area) -->
    <div
      data-account-menu-target="button"
      data-action="click->account-menu#toggle keydown.enter->account-menu#toggle keydown.space->account-menu#toggle"
      class="group flex items-center gap-3 w-full rounded-lg hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-1 p-2"
      tabindex="0"
      aria-haspopup="true"
      aria-expanded="false"
      role="button"
      aria-label="Open profile menu"
    >
    <!-- Avatar (left) -->
    <div class="flex-shrink-0">
      <% if current_user&.respond_to?(:avatar_url) && current_user.avatar_url.present? %>
        <%= image_tag current_user.avatar_url,
                      alt: (current_user.name.presence || current_user.email),
                      class: "h-9 w-9 rounded-full object-cover" %>
      <% else %>
        <div class="h-9 w-9 rounded-full bg-accent-orange text-white flex items-center justify-center text-sm font-medium select-none">
          <%= current_user&.name&.first&.upcase || current_user&.email&.first&.upcase || "U" %>
        </div>
      <% end %>
    </div>

    <!-- Name & plan (middle; truncates) -->
    <div class="min-w-0 flex-1">
      <div class="flex items-center justify-between gap-3">
        <div class="truncate text-sm font-medium text-neutral-900" title="<%= current_user&.name.presence || current_user&.email || 'Account' %>">
          <%= current_user&.name.presence || current_user&.email || "Account" %>
        </div>

        <!-- plan badge -->
        <div class="hidden sm:inline text-xs text-neutral-500">
          <%= (current_user&.plan.presence || "Free") rescue "Free" %>
        </div>
      </div>

      <div class="text-xs text-neutral-500 truncate">
        <%= current_user&.email %>
      </div>
    </div>

    </div>
    
    <!-- Upgrade CTA (right) -->
    <div class="flex-shrink-0 ml-2">
      <%= link_to pricing_path,
            class: "inline-flex items-center px-3 py-1.5 bg-accent-orange hover:bg-accent-orange-dark text-white text-sm font-medium rounded-md shadow-orange-soft transition-colors focus:outline-none focus:ring-2 focus:ring-accent-orange focus:ring-offset-2",
            aria: { label: "Upgrade" } do %>
        Upgrade
      <% end %>
    </div>
    
    <!-- Hidden popover menu (will be toggled by Stimulus) -->
    <div
      data-account-menu-target="menu"
      class="hidden absolute left-4 right-4 bottom-[64px] md:bottom-[74px] z-50 bg-white border border-neutral-100 rounded-lg shadow-lg py-2"
      role="menu"
      aria-hidden="true"
    >
      <%= link_to dashboard_path, class: "block px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50", role: "menuitem" do %>
        Dashboard
      <% end %>

      <%= link_to edit_user_registration_path, class: "block px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50", role: "menuitem" do %>
        Settings
      <% end %>

      <%= link_to support_path, class: "block px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50", role: "menuitem" do %>
        Help & Support
      <% end %>

      <div class="border-t border-neutral-100 my-1"></div>

      <%= button_to destroy_user_session_path,
            method: :delete,
            form: { class: "w-full" },
            class: "block w-full text-left px-4 py-2 text-sm text-neutral-700 hover:bg-neutral-50",
            role: "menuitem" do %>
        Sign out
      <% end %>
    </div>
  </div>
</div>
