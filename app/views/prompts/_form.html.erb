<% default_lib ||= {
  categories: [
    "Writing & Content", "Marketing & Growth", "Business & Productivity",
    "Code & Tech", "Learning & Knowledge", "Creative & Design", "Personal & Miscellaneous"
  ],
  tones_primary: ["Neutral", "Friendly", "Formal", "Conversational", "Persuasive", "Technical"],
  tones_all: ["Neutral","Friendly","Formal","Conversational","Persuasive","Technical","Informal","Professional","Empathetic","Playful","Academic","Authoritative"],
  formats_primary: ["Paragraph", "Bullet list", "Steps", "Short social post", "Email (subject + body)"],
  formats_all: ["Paragraph","Bullet list","Steps","Short social post","Email (subject + body)","Headline","FAQ","Table","Script","Outline","Poem"]
} %>

<% lib = defined?(PROMPT_LIBRARY) ? PROMPT_LIBRARY : default_lib %>
<% model = local_assigns[:prompt] || @prompt || Prompt.new %>

<style>
  /* subtle animated gradient accent used across all headers */
  @keyframes accent-slide {
    0% { transform: translateX(-8%); opacity: .9; }
    50% { transform: translateX(8%); opacity: 1; }
    100% { transform: translateX(-8%); opacity: .9; }
  }
  .animated-accent {
    animation: accent-slide 2.6s ease-in-out infinite;
    border-radius: 6px;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in-up { animation: fadeInUp .6s ease-out both; }
</style>

<%= form_with model: model, url: prompts_path, scope: :prompt, method: :post, local: false, html: { id: "prompt-form", class: "space-y-6 animate-fade-in-up" } do |f| %>
  <div class="space-y-4">

    <!-- Progress indicator (scroll-updating) -->
    <div class="flex items-center justify-center gap-3 mb-2">
      <div id="step-progress" class="inline-flex items-center gap-3" role="tablist" aria-label="Steps">
        <% (1..4).each do |i| %>
          <div class="step-dot w-3 h-3 rounded-full border border-neutral-200 bg-white" data-step-index="<%= i %>" aria-hidden="true"></div>
        <% end %>
      </div>
      <div id="step-label" class="text-xs text-neutral-500 ml-3" aria-live="polite">1 of 4</div>
    </div>

    <div id="prompt-steps" class="space-y-6">

      <!-- 1. Role / perspective -->
      <section class="p-4 rounded-xl bg-neutral-50 border border-neutral-100" data-step="1" aria-labelledby="step-1-title" tabindex="-1">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-4">
            <div class="w-16 h-1 animated-accent" style="background: linear-gradient(90deg,#FF7A18,#E65A00)"></div>
            <div>
              <h3 id="step-1-title" class="text-2xl md:text-3xl font-extrabold text-neutral-900">1. Role / perspective</h3>
              <p class="text-sm text-neutral-500 mt-0.5">Make the assistant adopt a persona — this shapes voice & examples.</p>
            </div>
          </div>
          <div class="text-sm text-neutral-500">1.</div>
        </div>

        <div class="mt-4">
          <div class="flex items-center gap-2 flex-wrap mb-3">
            <% ["Act as an experienced UX writer","Act as a senior developer","Act as a product manager"].each do |preset| %>
              <button
                type="button"
                class="role-chip inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm border bg-white text-neutral-700 hover:scale-105 hover:shadow-sm transition transform focus:outline-none focus:ring-2 focus:ring-accent-orange/30 cursor-pointer"
                data-role="<%= preset %>" aria-pressed="false"><%= preset %></button>
            <% end %>

            <button type="button" id="role-clear" class="inline-flex items-center px-3 py-1 rounded border text-xs text-neutral-500 hover:bg-neutral-100 transition focus:outline-none focus:ring-2 focus:ring-accent-orange/30 cursor-pointer">Clear</button>
          </div>

          <%= f.text_area :role,
              value: (defined?(@previous_input) && @previous_input && @previous_input[:role]) || params.dig(:prompt, :role) || f.object.try(:role) || "",
              rows: 4,
              maxlength: 600,
              class: "block w-full text-base leading-7 rounded-md border border-neutral-200 bg-white p-4 placeholder-neutral-400 focus:ring-2 focus:ring-accent-orange/20 focus:border-accent-orange transition-shadow",
              placeholder: 'Tell the model who to be (e.g., "Act as an experienced UX writer")' %>
        </div>
      </section>

      <!-- 2. Your idea -->
      <section class="p-4 rounded-xl bg-white border border-neutral-100" data-step="2" aria-labelledby="step-2-title" tabindex="-1">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-4">
            <div class="w-16 h-1 animated-accent" style="background: linear-gradient(90deg,#FF7A18,#E65A00)"></div>
            <div>
              <h3 id="step-2-title" class="text-2xl md:text-3xl font-extrabold text-neutral-900">2. Your idea</h3>
              <p class="text-sm text-neutral-500 mt-0.5">Describe the goal, audience and constraints.</p>
            </div>
          </div>
          <div class="text-sm text-neutral-500">2.</div>
        </div>

        <div class="mt-4">
          <%= f.label :idea, "Your idea", class: "block text-sm font-medium text-neutral-800" %>
          <%= f.text_area :idea,
                value: (defined?(@previous_input) && @previous_input && @previous_input[:idea]) || params.dig(:prompt, :idea) || f.object.try(:idea) || "",
                rows: 6,
                class: "mt-2 block w-full rounded-lg border border-neutral-200 bg-white p-3 placeholder-neutral-400 focus:ring-2 focus:ring-accent-orange/20 focus:border-accent-orange transition-shadow",
                placeholder: "Describe the idea or goal for this prompt" %>
          <p class="text-xs text-neutral-500 mt-1">Tip: include context, desired examples and constraints.</p>
        </div>
      </section>

      <!-- 3. Category, tone & format -->
      <section class="p-4 rounded-xl bg-neutral-50 border border-neutral-100" data-step="3" aria-labelledby="step-3-title" tabindex="-1">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-4">
            <div class="w-16 h-1 animated-accent" style="background: linear-gradient(90deg,#FF7A18,#E65A00)"></div>
            <div>
              <h3 id="step-3-title" class="text-2xl md:text-3xl font-extrabold text-neutral-900">3. Category, tone & format</h3>
              <p class="text-sm text-neutral-500 mt-0.5">Structure the output and categorize it for reuse.</p>
            </div>
          </div>
          <div class="text-sm text-neutral-500">3.</div>
        </div>

        <div class="mt-4 space-y-4">
          <!-- Category -->
          <div>
            <label class="block text-sm font-medium text-neutral-800 mb-2">Category</label>
            <div class="flex flex-wrap gap-2">
              <% lib[:categories].each do |c| %>
                <% selected = ((defined?(@previous_input) && @previous_input && @previous_input[:category]) || f.object.try(:category)) == c %>
                <button
                  type="button"
                  class="category-chip inline-flex items-center px-3 py-1 rounded-full text-sm border transition transform hover:scale-105 hover:shadow-sm cursor-pointer <%= selected ? 'bg-accent-orange text-white border-accent-orange' : 'bg-white text-neutral-700' %>"
                  data-value="<%= c %>" aria-pressed="<%= selected %>"><%= c %></button>
              <% end %>
              <input id="category-custom" class="ml-2 rounded-md border border-neutral-200 p-2 text-sm placeholder-neutral-400 focus:ring-2 focus:ring-accent-orange/20 focus:border-accent-orange transition" placeholder="Custom category" value="<%= (defined?(@previous_input) && @previous_input && @previous_input[:category] && !lib[:categories].include?(@previous_input[:category]) ? @previous_input[:category] : (params.dig(:prompt, :category) unless lib[:categories].include?(params.dig(:prompt, :category)))) || (f.object.try(:category) unless lib[:categories].include?(f.object.try(:category))) || '' %>" />
            </div>
            <%= f.hidden_field :category, value: (defined?(@previous_input) && @previous_input && @previous_input[:category]) || params.dig(:prompt, :category) || f.object.try(:category), id: "category-hidden" %>
          </div>

          <!-- Tone -->
          <div>
            <label class="block text-sm font-medium text-neutral-800 mb-2">Tone</label>
            <div class="flex items-center gap-2 flex-wrap">
              <% lib[:tones_primary].each do |t| %>
                <% selected = ((defined?(@previous_input) && @previous_input && @previous_input[:tone]) || f.object.try(:tone)) == t %>
                <button type="button" class="tone-chip inline-flex items-center px-3 py-1 rounded-md text-sm border transition transform hover:scale-105 hover:shadow-sm cursor-pointer <%= selected ? 'bg-accent-orange text-white border-accent-orange' : 'bg-white text-neutral-700' %>" data-value="<%= t %>" aria-pressed="<%= selected %>"><%= t %></button>
              <% end %>

              <div class="relative">
                <button type="button" id="tone-more-toggle" class="inline-flex items-center px-3 py-1 rounded-md border text-sm bg-white hover:scale-105 transition focus:outline-none focus:ring-2 focus:ring-accent-orange/30 cursor-pointer">More ▾</button>
                <span id="tone-selected-label" class="ml-2 text-xs text-neutral-600 hidden"></span>

                <div id="tone-more" class="hidden absolute mt-2 right-0 z-20 w-48 bg-white border rounded-md shadow-lg p-2">
                  <div class="text-xs text-neutral-500 mb-2">All tones</div>
                  <div class="flex flex-col gap-1 max-h-40 overflow-auto">
                    <% lib[:tones_all].each do |t| %>
                      <button type="button" class="tone-more-item text-left px-2 py-1 rounded hover:bg-neutral-50 text-sm transition cursor-pointer" data-value="<%= t %>"><%= t %></button>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
            <%= f.hidden_field :tone, value: (defined?(@previous_input) && @previous_input && @previous_input[:tone]) || params.dig(:prompt, :tone) || f.object.try(:tone), id: "tone-hidden" %>
          </div>

          <!-- Format -->
          <div>
            <label class="block text-sm font-medium text-neutral-800 mb-2">Format</label>
            <div class="flex items-center gap-2 flex-wrap">
              <% lib[:formats_primary].each do |fmt| %>
                <% selected = ((defined?(@previous_input) && @previous_input && @previous_input[:format]) || f.object.try(:format)) == fmt %>
                <button type="button" class="format-chip inline-flex items-center px-3 py-1 rounded-md text-sm border transition transform hover:scale-105 hover:shadow-sm cursor-pointer <%= selected ? 'bg-accent-orange text-white border-accent-orange' : 'bg-white text-neutral-700' %>" data-value="<%= fmt %>" aria-pressed="<%= selected %>"><%= fmt %></button>
              <% end %>

              <div class="relative">
                <button type="button" id="format-more-toggle" class="inline-flex items-center px-3 py-1 rounded-md border text-sm bg-white hover:scale-105 transition focus:outline-none focus:ring-2 focus:ring-accent-orange/30 cursor-pointer">More ▾</button>
                <span id="format-selected-label" class="ml-2 text-xs text-neutral-600 hidden"></span>

                <div id="format-more" class="hidden absolute mt-2 right-0 z-20 w-56 bg-white border rounded-md shadow-lg p-2">
                  <div class="text-xs text-neutral-500 mb-2">All formats</div>
                  <div class="flex flex-col gap-1 max-h-44 overflow-auto">
                    <% lib[:formats_all].each do |fmt| %>
                      <button type="button" class="format-more-item text-left px-2 py-1 rounded hover:bg-neutral-50 text-sm transition cursor-pointer" data-value="<%= fmt %>"><%= fmt %></button>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
            <%= f.hidden_field :format, value: (defined?(@previous_input) && @previous_input && @previous_input[:format]) || params.dig(:prompt, :format) || f.object.try(:format), id: "format-hidden" %>
          </div>
        </div>
      </section>

      <!-- 4. Audience & submit -->
      <section class="p-4 rounded-xl bg-white border border-neutral-100" data-step="4" aria-labelledby="step-4-title" tabindex="-1">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-4">
            <div class="w-16 h-1 animated-accent" style="background: linear-gradient(90deg,#FF7A18,#E65A00)"></div>
            <div>
              <h3 id="step-4-title" class="text-2xl md:text-3xl font-extrabold text-neutral-900">4. Audience & output</h3>
              <p class="text-sm text-neutral-500 mt-0.5">Finalise audience and generate the prompt.</p>
            </div>
          </div>
          <div class="text-sm text-neutral-500">4.</div>
        </div>

        <div class="mt-4 flex gap-4 items-end">
          <div class="flex-1">
            <%= f.label :audience, "Audience / Tags", class: "block text-sm font-medium text-neutral-800" %>
            <%= f.text_field :audience,
              value: (defined?(@previous_input) && @previous_input && @previous_input[:audience]) || params.dig(:prompt, :audience) || f.object.try(:audience) || "",
              placeholder: "e.g. Developers, HR, Small business",
              class: "mt-1 block w-full rounded-md border border-neutral-200 p-2 focus:ring-2 focus:ring-accent-orange/20 focus:border-accent-orange transition" %>
          </div>

          <!-- Output length removed per request -->
        </div>

        <div class="mt-6">
          <div class="mx-auto w-full max-w-md">
            <%= f.submit (f.object.persisted? ? "Update Prompt" : "Generate Prompt"),
                class: "w-full px-4 py-3 bg-accent-orange text-white rounded-lg hover:bg-accent-orange/90 transition-colors duration-200 cursor-pointer text-center font-semibold" %>
          </div>
        </div>
      </section>

    </div>
  </div>
<% end %>

<!-- UI Script: chips, tone/format popovers, scroll-updating progress dots (length logic removed) -->
<script>
(function initPromptFormUI() {
  const root = document.getElementById('prompt-form');
  if (!root) return;
  if (root.dataset.initialized === 'true') return;
  root.dataset.initialized = 'true';

  const activateVisualChip = (btn) => {
    const parent = btn.parentElement;
    if (parent) parent.querySelectorAll('button[data-value]').forEach(s => {
      s.classList.remove('bg-accent-orange','text-white','border-accent-orange');
      s.classList.add('bg-white','text-neutral-700');
      s.setAttribute('aria-pressed','false');
    });
    btn.classList.remove('bg-white','text-neutral-700');
    btn.classList.add('bg-accent-orange','text-white','border-accent-orange');
    btn.setAttribute('aria-pressed','true');
  };

  const clearChips = (chips) => {
    chips.forEach(x => {
      x.classList.remove('bg-accent-orange','text-white','border-accent-orange');
      x.classList.add('bg-white','text-neutral-700');
      x.setAttribute('aria-pressed','false');
    });
  };

  // CATEGORY
  (function() {
    const chips = root.querySelectorAll('.category-chip');
    const custom = root.querySelector('#category-custom');
    const hidden = root.querySelector('#category-hidden');
    const initVal = hidden ? hidden.value : '';
    if (initVal) {
      let matched = false;
      chips.forEach(c => { if (c.dataset.value === initVal) { activateVisualChip(c); matched = true; }});
      if (!matched && custom) custom.value = initVal;
    }

    chips.forEach(c => {
      c.addEventListener('click', () => {
        activateVisualChip(c);
        if (custom) custom.value = '';
        if (hidden) hidden.value = c.dataset.value;
      });
      c.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); c.click(); } });
    });

    if (custom) {
      custom.addEventListener('input', () => {
        clearChips(chips);
        if (hidden) hidden.value = custom.value;
      });
    }
  })();

  // ROLE presets
  (function() {
    const roleChips = root.querySelectorAll('.role-chip');
    const roleClear = root.querySelector('#role-clear');
    const roleEl = root.querySelector('textarea[name="prompt[role]"]');

    roleChips.forEach(btn => {
      btn.addEventListener('click', () => {
        if (roleEl) { roleEl.focus(); roleEl.value = btn.dataset.role || btn.innerText; roleEl.dispatchEvent(new Event('input', { bubbles: true })); }
        roleChips.forEach(x => x.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
      });
      btn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); } });
    });

    if (roleClear && roleEl) {
      roleClear.addEventListener('click', () => {
        roleEl.value = '';
        roleEl.dispatchEvent(new Event('input', { bubbles: true }));
        roleEl.focus();
        roleChips.forEach(x => x.setAttribute('aria-pressed','false'));
      });
    }
  })();

  // TONE
  (function() {
    const hidden = root.querySelector('#tone-hidden');
    const chips = root.querySelectorAll('.tone-chip');
    const moreToggle = root.querySelector('#tone-more-toggle');
    const more = root.querySelector('#tone-more');
    const items = root.querySelectorAll('.tone-more-item');
    const label = root.querySelector('#tone-selected-label');

    const initVal = hidden ? hidden.value : '';
    if (initVal) {
      let matched = false;
      chips.forEach(c => { if (c.dataset.value === initVal) { activateVisualChip(c); matched = true; }});
      if (!matched && label) { label.textContent = "Selected: " + initVal; label.classList.remove('hidden'); }
    }

    chips.forEach(c => {
      c.addEventListener('click', () => {
        activateVisualChip(c);
        if (hidden) hidden.value = c.dataset.value;
        if (label) { label.classList.add('hidden'); label.textContent = ''; }
      });
    });

    if (moreToggle && more) {
      moreToggle.addEventListener('click', (e) => { e.preventDefault(); more.classList.toggle('hidden'); });
      document.addEventListener('click', (e) => { if (!more.contains(e.target) && e.target !== moreToggle) more.classList.add('hidden'); });
    }

    items.forEach(it => {
      it.addEventListener('click', () => {
        const v = it.dataset.value || it.innerText;
        if (hidden) hidden.value = v;
        clearChips(chips);
        if (label) { label.textContent = "Selected: " + v; label.classList.remove('hidden'); }
        if (more) more.classList.add('hidden');
      });
    });
  })();

  // FORMAT
  (function() {
    const hidden = root.querySelector('#format-hidden');
    const chips = root.querySelectorAll('.format-chip');
    const moreToggle = root.querySelector('#format-more-toggle');
    const more = root.querySelector('#format-more');
    const items = root.querySelectorAll('.format-more-item');
    const label = root.querySelector('#format-selected-label');

    const initVal = hidden ? hidden.value : '';
    if (initVal) {
      let matched = false;
      chips.forEach(c => { if (c.dataset.value === initVal) { activateVisualChip(c); matched = true; }});
      if (!matched && label) { label.textContent = "Selected: " + initVal; label.classList.remove('hidden'); }
    }

    chips.forEach(c => {
      c.addEventListener('click', () => {
        activateVisualChip(c);
        if (hidden) hidden.value = c.dataset.value;
        if (label) { label.classList.add('hidden'); label.textContent = ''; }
      });
    });

    if (moreToggle && more) {
      moreToggle.addEventListener('click', (e) => { e.preventDefault(); more.classList.toggle('hidden'); });
      document.addEventListener('click', (e) => { if (!more.contains(e.target) && e.target !== moreToggle) more.classList.add('hidden'); });
    }

    items.forEach(it => {
      it.addEventListener('click', () => {
        const v = it.dataset.value || it.innerText;
        if (hidden) hidden.value = v;
        chips.forEach(x => x.classList.remove('bg-accent-orange','text-white','border-accent-orange'));
        if (label) { label.textContent = "Selected: " + v; label.classList.remove('hidden'); }
        if (more) more.classList.add('hidden');
      });
    });
  })();

  // Progress dots update on scroll — steps are always visible, observer only updates UI
  (function() {
    const steps = Array.from(root.querySelectorAll('[data-step]'));
    const dots = Array.from(root.querySelectorAll('.step-dot'));
    const label = root.querySelector('#step-label');

    if (!('IntersectionObserver' in window)) return;

    const obs = new IntersectionObserver((entries) => {
      const visible = entries.filter(e => e.isIntersecting).sort((a,b) => b.intersectionRatio - a.intersectionRatio)[0];
      let idx = 0;
      if (visible) idx = steps.indexOf(visible.target);
      else {
        idx = steps.findIndex(s => s.getBoundingClientRect().top >= 0);
        if (idx === -1) idx = 0;
      }

      dots.forEach((d,i) => {
        if (i === idx) {
          d.classList.add('bg-accent-orange');
          d.classList.remove('bg-white');
        } else {
          d.classList.remove('bg-accent-orange');
          d.classList.add('bg-white');
        }
      });

      if (label) label.textContent = `${idx+1} of ${steps.length}`;
    }, { threshold: [0.3, 0.5, 0.8] });

    steps.forEach(s => obs.observe(s));
  })();

})();
</script>
