<%# Optional: set a page title for layout %>
<% content_for :title, "Pricing — DevWerkhouz" %>

<section class="bg-neutral-50 min-h-screen flex items-center justify-center py-12">
  <div class="w-full max-w-4xl px-6">
    <div class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-neutral-800">Pricing Plans</h1>
      <p class="mt-3 text-neutral-600">Choose a plan that fits your prompt-powered workflow — generate, save & reuse prompts.</p>
    </div>

    <div class="grid gap-8 md:grid-cols-2">
      <!-- Pro Plan -->
      <div class="relative bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-8 flex flex-col">
        <div class="absolute left-6 top-6 w-12 h-1 rounded" style="background: linear-gradient(90deg,#FF7A18,#E65A00)"></div>

        <div class="mt-4">
          <h2 class="text-2xl font-bold text-brand mb-3">Pro</h2>
          <p class="text-neutral-600 mb-6">Full access: generate, save, export unlimited prompts + priority support.</p>
          <p class="text-neutral-800 font-semibold text-lg mb-6">€12 / month</p>
        </div>

        <div class="mt-auto">
          <button id="checkout-button"
                  data-price-id="<%= ENV['STRIPE_PRICE_ID'] || 'price_1SATZaIoRaH50WhR5sShQueN' %>"
                  class="w-full inline-block px-6 py-3 bg-accent-orange hover:bg-accent-orange-dark text-white font-bold rounded-lg shadow-orange-strong transition-colors disabled:opacity-60">
            Subscribe
          </button>

          <p class="mt-3 text-xs text-neutral-500">Secure checkout powered by Stripe. You can cancel anytime.</p>
        </div>
      </div>

      <!-- Starter Plan -->
      <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow p-8 flex flex-col">
        <div>
          <h2 class="text-2xl font-bold text-neutral-800 mb-3">Starter</h2>
          <p class="text-neutral-600 mb-6">Try it out: generate prompts with limited saves.</p>
          <p class="text-neutral-800 font-semibold text-lg mb-6">Free</p>
        </div>

        <div class="mt-auto">
          <%= link_to "Get Started", root_path, class: "w-full inline-block px-6 py-3 bg-gray-300 hover:bg-gray-400 text-neutral-800 font-bold rounded-lg shadow transition-colors text-center" %>
          <p class="mt-3 text-xs text-neutral-500">No card required — start composing prompts right away.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<%# Inject Stripe publishable key for JS to read %>
<meta name="stripe-pk" content="<%= ENV['STRIPE_PUBLISHABLE_KEY'] || Rails.application.credentials.dig(:stripe, :public_key) %>">

<%= javascript_tag do %>
  document.addEventListener('DOMContentLoaded', () => {
    const pk = document.querySelector('meta[name="stripe-pk"]').content;
    if (!pk) {
      console.warn('Stripe publishable key not set (STRIPE_PUBLISHABLE_KEY)');
      return;
    }
    const stripe = Stripe(pk);

    const checkoutBtn = document.getElementById('checkout-button');
    if (!checkoutBtn) return;

    checkoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      checkoutBtn.disabled = true;
      checkoutBtn.innerText = 'Preparing…';

      const priceId = checkoutBtn.dataset.priceId;

      try {
        const resp = await fetch('<%= create_checkout_session_path %>', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector("meta[name='csrf-token']").content
          },
          body: JSON.stringify({ priceId })
        });

        const data = await resp.json();

        if (resp.ok && data.url) {
          window.location.href = data.url;
        } else {
          alert(data.error || 'Error creating checkout session');
          checkoutBtn.disabled = false;
          checkoutBtn.innerText = 'Subscribe';
        }
      } catch (err) {
        console.error(err);
        alert('Network error while creating checkout session');
        checkoutBtn.disabled = false;
        checkoutBtn.innerText = 'Subscribe';
      }
    });
  });
<% end %>
